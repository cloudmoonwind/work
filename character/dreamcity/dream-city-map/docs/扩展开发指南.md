# æ‰©å±•å¼€å‘æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•æ‰©å±•å’Œä¼˜åŒ–æ¢¦æƒ³åŸåœ°å›¾ç³»ç»Ÿã€‚

## 1. æ·»åŠ æ–°åœ°ç‚¹

### æ­¥éª¤

1. **ç¼–è¾‘ `src/data/locations.json`**
   
   æ·»åŠ æ–°åœ°ç‚¹å¯¹è±¡ï¼š
   ```json
   {
     "id": "loc_023",
     "name": "å’–å•¡é¦†",
     "nameEn": "Cafe",
     "type": "public",
     "category": "food",
     "position": {
       "x": 550,
       "y": 650
     },
     "zoneId": "zone_004",
     "nearestNodes": ["node_025"],
     "status": "active",
     "description": "æ¸©é¦¨çš„å’–å•¡é¦†ï¼Œåˆåé˜³å…‰çš„æœ€ä½³å»å¤„ã€‚",
     "openHours": "08:00-22:00",
     "tags": ["coffee", "relaxation"],
     "interactions": ["drink", "chat", "read"],
     "icon": "coffee",
     "importance": 6
   }
   ```

2. **ç¡®å®šåæ ‡**
   - æ‰“å¼€åœ°å›¾ï¼Œæ‰¾åˆ°åˆé€‚çš„ç©ºç™½åŒºåŸŸ
   - è®°å½•åæ ‡ï¼ˆx: 0-1000, y: 0-1200ï¼‰
   - ç¡®ä¿ä¸ä¸å…¶ä»–åœ°ç‚¹é‡å 

3. **å…³è”é“è·¯èŠ‚ç‚¹**
   - æŸ¥çœ‹ `roadNetwork.json` æ‰¾åˆ°æœ€è¿‘çš„èŠ‚ç‚¹
   - å°†èŠ‚ç‚¹IDæ·»åŠ åˆ° `nearestNodes` æ•°ç»„

4. **æ›´æ–°åŒºåŸŸæ•°æ®**ï¼ˆå¯é€‰ï¼‰
   - å¦‚æœåœ°ç‚¹åœ¨æ–°åŒºåŸŸï¼Œéœ€è¦åœ¨ `zones.json` ä¸­æ·»åŠ è¯¥åŒºåŸŸ
   - æ›´æ–°å¯¹åº”åŒºåŸŸçš„ `locationsCount` å’Œ `locationIds`

### å›¾æ ‡æ‰©å±•

å¦‚æœéœ€è¦æ–°çš„å›¾æ ‡ç±»å‹ï¼Œç¼–è¾‘ `src/components/LocationMarker.jsx`ï¼š

```javascript
case 'coffee':
  return (
    <text x={iconX} y={iconY} fontSize={iconSize} textAnchor="middle" dominantBaseline="central">
      â˜•
    </text>
  );
```

æˆ–ä½¿ç”¨ SVG å›¾æ ‡åº“ï¼ˆæ¨è Lucide React æˆ– Font Awesomeï¼‰ã€‚

## 2. æ·»åŠ é“è·¯å’ŒèŠ‚ç‚¹

### æ·»åŠ é“è·¯èŠ‚ç‚¹

ç¼–è¾‘ `src/data/roadNetwork.json` çš„ `nodes` æ•°ç»„ï¼š

```json
{
  "id": "node_080",
  "position": {"x": 550, "y": 650},
  "type": "junction",
  "name": "å’–å•¡é¦†è·¯å£",
  "connectedTo": ["node_025", "node_026"]
}
```

### æ·»åŠ é“è·¯

```json
{
  "id": "road_033",
  "name": "å’–å•¡é¦†å°è·¯",
  "from": "node_025",
  "to": "node_080",
  "width": 5,
  "type": "branch",
  "path": [
    {"x": 690, "y": 600},
    {"x": 620, "y": 625, "control": true},
    {"x": 550, "y": 650}
  ]
}
```

### æ›²çº¿é“è·¯

ä½¿ç”¨è´å¡å°”æ›²çº¿åˆ›å»ºå¹³æ»‘è·¯å¾„ï¼š
- `"control": true` æ ‡è®°æ§åˆ¶ç‚¹
- æ§åˆ¶ç‚¹ä¼šè¢«ç”¨äºç”Ÿæˆå¹³æ»‘æ›²çº¿

## 3. åŠŸèƒ½æ‰©å±•

### 3.1 è§’è‰²ç§»åŠ¨ç³»ç»Ÿ

åˆ›å»º `src/utils/pathfinding.js`ï¼š

```javascript
export function findPath(startNodeId, endNodeId, roadNetwork) {
  // A* ç®—æ³•å®ç°
  // è¿”å›è·¯å¾„æ•°ç»„
}

export function animateCharacterMovement(character, path, duration) {
  // è§’è‰²æ²¿è·¯å¾„ç§»åŠ¨çš„åŠ¨ç”»
}
```

åœ¨åœ°å›¾ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```javascript
import { findPath, animateCharacterMovement } from '../utils/pathfinding';

const handleNavigate = (targetLocation) => {
  const path = findPath(currentLocation.nearestNodes[0], targetLocation.nearestNodes[0], roadNetwork);
  animateCharacterMovement(character, path, 2000);
};
```

### 3.2 æ—¶é—´ç³»ç»Ÿ

åˆ›å»º `src/utils/timeSystem.js`ï¼š

```javascript
export class TimeSystem {
  constructor() {
    this.hour = 12;
    this.day = 1;
    this.season = 'spring';
  }

  tick() {
    this.hour++;
    if (this.hour >= 24) {
      this.hour = 0;
      this.day++;
    }
  }

  getLighting() {
    if (this.hour >= 6 && this.hour < 18) {
      return 'day';
    } else if (this.hour >= 18 && this.hour < 20) {
      return 'evening';
    } else {
      return 'night';
    }
  }
}
```

é›†æˆåˆ°åœ°å›¾ï¼š

```javascript
const [timeSystem] = useState(new TimeSystem());

useEffect(() => {
  const interval = setInterval(() => {
    timeSystem.tick();
    // æ›´æ–°åœ°å›¾å…‰ç…§
  }, 1000); // æ¯ç§’é’Ÿtickä¸€æ¬¡

  return () => clearInterval(interval);
}, []);
```

### 3.3 å¤©æ°”ç³»ç»Ÿ

åˆ›å»º `src/utils/weatherSystem.js`ï¼š

```javascript
export class WeatherSystem {
  constructor() {
    this.weather = 'sunny';
    this.effects = [];
  }

  setWeather(weather) {
    this.weather = weather;
    this.updateEffects();
  }

  updateEffects() {
    switch(this.weather) {
      case 'rain':
        this.effects = ['rain-particles', 'clouds'];
        break;
      case 'snow':
        this.effects = ['snow-particles', 'fog'];
        break;
      default:
        this.effects = [];
    }
  }
}
```

### 3.4 äº‹ä»¶ç³»ç»Ÿ

åˆ›å»º `src/utils/eventSystem.js`ï¼š

```javascript
export class EventManager {
  constructor() {
    this.events = [];
  }

  addEvent(locationId, eventType, data) {
    this.events.push({
      id: Date.now(),
      locationId,
      eventType,
      data,
      timestamp: new Date()
    });
  }

  getEventsForLocation(locationId) {
    return this.events.filter(e => e.locationId === locationId);
  }
}
```

## 4. æ•°æ®æŒä¹…åŒ–

### 4.1 LocalStorage

```javascript
// ä¿å­˜æ¸¸æˆçŠ¶æ€
export function saveGameState(state) {
  localStorage.setItem('dreamCityState', JSON.stringify(state));
}

// åŠ è½½æ¸¸æˆçŠ¶æ€
export function loadGameState() {
  const saved = localStorage.getItem('dreamCityState');
  return saved ? JSON.parse(saved) : null;
}
```

### 4.2 åç«¯APIå¯¹æ¥

åˆ›å»º `src/api/client.js`ï¼š

```javascript
const API_BASE = 'https://api.dreamcity.com';

export async function fetchLocations() {
  const response = await fetch(`${API_BASE}/locations`);
  return response.json();
}

export async function updateLocation(locationId, data) {
  const response = await fetch(`${API_BASE}/locations/${locationId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return response.json();
}

export async function getCharacterPosition(characterId) {
  const response = await fetch(`${API_BASE}/characters/${characterId}/position`);
  return response.json();
}
```

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 è™šæ‹ŸåŒ–æ¸²æŸ“

åªæ¸²æŸ“è§†å£å†…çš„å…ƒç´ ï¼š

```javascript
const isInViewport = (x, y, viewportBounds) => {
  return x >= viewportBounds.left && 
         x <= viewportBounds.right && 
         y >= viewportBounds.top && 
         y <= viewportBounds.bottom;
};

const visibleLocations = locations.filter(loc => 
  isInViewport(loc.position.x, loc.position.y, viewportBounds)
);
```

### 5.2 Canvasæ¸²æŸ“ï¼ˆå¯é€‰ï¼‰

å¯¹äºå¤æ‚åŠ¨ç”»ï¼Œè€ƒè™‘ä½¿ç”¨Canvasä»£æ›¿SVGï¼š

```javascript
// åˆ›å»ºæ··åˆæ¸²æŸ“ï¼šSVGç”¨äºé™æ€å…ƒç´ ï¼ŒCanvasç”¨äºåŠ¨ç”»
const renderToCanvas = (ctx, locations) => {
  locations.forEach(loc => {
    ctx.beginPath();
    ctx.arc(loc.position.x, loc.position.y, 20, 0, Math.PI * 2);
    ctx.fillStyle = loc.type === 'public' ? '#A8D8EA' : '#FFB6C1';
    ctx.fill();
  });
};
```

### 5.3 Reactä¼˜åŒ–

```javascript
// ä½¿ç”¨ React.memo é˜²æ­¢ä¸å¿…è¦çš„é‡æ¸²æŸ“
const LocationMarker = React.memo(({ location, ...props }) => {
  // ...
}, (prevProps, nextProps) => {
  return prevProps.location.id === nextProps.location.id &&
         prevProps.isSelected === nextProps.isSelected;
});

// ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const visibleLocations = useMemo(() => {
  return locations.filter(loc => isInViewport(loc, viewport));
}, [locations, viewport]);
```

## 6. æ ·å¼å®šåˆ¶

### 6.1 ä¸»é¢˜åˆ‡æ¢

åˆ›å»ºå¤šå¥—é…è‰²æ–¹æ¡ˆï¼š

```javascript
const themes = {
  mucha: {
    colors: {
      background: '#FFF9E6',
      primary: '#D4A574',
      // ...
    }
  },
  dark: {
    colors: {
      background: '#1A1A2E',
      primary: '#16213E',
      // ...
    }
  }
};

const [currentTheme, setCurrentTheme] = useState('mucha');
```

### 6.2 åŠ¨ç”»æ•ˆæœ

æ·»åŠ æ›´å¤šåŠ¨ç”»ï¼š

```css
@keyframes ripple {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}

.location-marker.active::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: rgba(168, 216, 234, 0.5);
  animation: ripple 2s infinite;
}
```

## 7. æµ‹è¯•

### 7.1 å•å…ƒæµ‹è¯•

ä½¿ç”¨ Vitestï¼š

```javascript
import { describe, it, expect } from 'vitest';
import { findPath } from '../utils/pathfinding';

describe('Pathfinding', () => {
  it('should find shortest path', () => {
    const path = findPath('node_010', 'node_020', roadNetwork);
    expect(path).toBeDefined();
    expect(path.length).toBeGreaterThan(0);
  });
});
```

### 7.2 é›†æˆæµ‹è¯•

ä½¿ç”¨ React Testing Libraryï¼š

```javascript
import { render, fireEvent } from '@testing-library/react';
import DreamCityMap from './DreamCityMap';

test('clicking location shows popup', () => {
  const { getByText, getByRole } = render(<DreamCityMap />);
  const location = getByText('ä¸­å¤®å–·æ³‰å¹¿åœº');
  fireEvent.click(location);
  expect(getByRole('dialog')).toBeInTheDocument();
});
```

## 8. éƒ¨ç½²

### 8.1 æ„å»º

```bash
npm run build
```

### 8.2 éƒ¨ç½²åˆ°é™æ€æ‰˜ç®¡

```bash
# Vercel
vercel --prod

# Netlify
netlify deploy --prod

# GitHub Pages
npm run build
gh-pages -d dist
```

### 8.3 ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```
VITE_API_BASE=https://api.dreamcity.com
VITE_ENABLE_ANALYTICS=true
```

ä½¿ç”¨ï¼š

```javascript
const apiBase = import.meta.env.VITE_API_BASE;
```

## 9. å¸¸è§é—®é¢˜

### Q: å¦‚ä½•è°ƒè¯•åæ ‡ï¼Ÿ

åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºé¼ æ ‡åæ ‡ï¼š

```javascript
const [mousePos, setMousePos] = useState({ x: 0, y: 0 });

const handleMouseMove = (e) => {
  const svg = svgRef.current;
  const pt = svg.createSVGPoint();
  pt.x = e.clientX;
  pt.y = e.clientY;
  const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
  setMousePos({ x: Math.round(svgP.x), y: Math.round(svgP.y) });
};

// æ˜¾ç¤ºåæ ‡
<div className="debug-coords">
  X: {mousePos.x}, Y: {mousePos.y}
</div>
```

### Q: å¦‚ä½•æé«˜å¤§é‡åœ°ç‚¹æ—¶çš„æ€§èƒ½ï¼Ÿ

1. ä½¿ç”¨å››å‰æ ‘ç©ºé—´ç´¢å¼•
2. å®ç°LODï¼ˆLevel of Detailï¼‰ç³»ç»Ÿ
3. ä»…æ¸²æŸ“è§†å£å†…å…ƒç´ 
4. ä½¿ç”¨ Canvas æ¸²æŸ“åŠ¨æ€å…ƒç´ 

### Q: å¦‚ä½•å®ç°åœ°ç‚¹æœç´¢ï¼Ÿ

```javascript
const searchLocations = (query) => {
  return locations.filter(loc => 
    loc.name.includes(query) || 
    loc.tags.some(tag => tag.includes(query))
  );
};
```

## 10. è¿›é˜¶åŠŸèƒ½å»ºè®®

1. **å¤šè¯­è¨€æ”¯æŒ**ï¼ši18né›†æˆ
2. **æ— éšœç¢è®¿é—®**ï¼šARIAæ ‡ç­¾ã€é”®ç›˜å¯¼èˆª
3. **ç§»åŠ¨ç«¯ä¼˜åŒ–**ï¼šè§¦æ‘¸æ‰‹åŠ¿ã€å“åº”å¼å¸ƒå±€
4. **æ•°æ®åˆ†æ**ï¼šç”¨æˆ·è¡Œä¸ºè¿½è¸ª
5. **ç¤¾äº¤åŠŸèƒ½**ï¼šå¥½å‹ç³»ç»Ÿã€æ’è¡Œæ¦œ
6. **æˆå°±ç³»ç»Ÿ**ï¼šè§£é”åœ°ç‚¹ã€æ”¶é›†å¾½ç« 
7. **å°åœ°å›¾**ï¼šç¼©ç•¥å›¾å¯¼èˆª
8. **å¯¼å‡ºåŠŸèƒ½**ï¼šæˆªå›¾ã€åˆ†äº«

## ç»“è¯­

æœ¬é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•ã€‚æŒ‰ç…§ä»¥ä¸ŠæŒ‡å—ï¼Œä½ å¯ä»¥è½»æ¾æ·»åŠ æ–°åŠŸèƒ½æˆ–ä¼˜åŒ–ç°æœ‰ç³»ç»Ÿã€‚

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£æˆ–æäº¤ Issueã€‚

ç¥å¼€å‘æ„‰å¿«ï¼ğŸ®âœ¨
